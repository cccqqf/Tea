var HomeView=Backbone.View.extend({el:$("#content"),events:{"click #load_import":"load_imports","click #top_city li":"change_tops","click #show_des":"show_des","click #desc_cats a":"show_desc_sub","click #show_nav_modal":"show_nav_modal","click #my_navs_change a":"change_nav","click #save_nav":"save_nav","click .delete-mynav":"delete_mynav"},initialize:function(){this.import_temp=_.template($("#import_temp").html());this.tops_temp=_.template($("#tops_temp").html());this.load_imports();this.load_navs();this.show_chart();this.load_tops($("#citypostcode").val())},show_desc_sub:function(e){$("#desc_cats .active").removeClass("active");var t=$(e.currentTarget).addClass("active").attr("href").substr(1);this.search_des(t);e.preventDefault()},show_des:function(){this.search_des()},search_des:function(e){if(!this.category||this.category!=e){this.category=e}else{$("html, body").scrollTop(760);return}$("#description").show();$.ajax({url:"/category/description",type:"get",dataType:"json",data:{city:$("#citypostcode").val(),category:e},success:function(e){var t=e.bcats;if($("#desc_cats").text().length==0){var a='<a href="#" class="active">鎵€鏈�</a>';_.each(t,function(e,t){a+='<a href="#'+e.category+'">'+e.name+"</a>"});$("#desc_cats").append(a)}var r=e.cates;var i=_.template($("#description_temp").html());$("#des1,#des2,#des3,#des4").empty();var s={name:"des1",height:function(){return $("#des1").height()}},n={name:"des2",height:function(){return $("#des2").height()}},o={name:"des3",height:function(){return $("#des3").height()}},c={name:"des4",height:function(){return $("#des4").height()}};_.each(r,function(e){var t=_.min([s,n,o,c],function(e){return e.height()});$("#"+t.name).append(i(e))});$("html, body").scrollTop(760)}})},show_nav_modal:function(e){$("#nav_modal").modal("show");$("#save_info").empty();this.userNavs=this.userNavs||[]},change_nav:function(e){$("#save_info").empty();var t=$(e.currentTarget).attr("href");$("#my_navs_change .active").removeClass("active");$(e.currentTarget).parent().addClass("active");$("#allnavs,#mynavs").hide();$(t).show();e.preventDefault()},save_nav:function(e){if($("#allnavs :checked").length<=0){return}var t=this;$("#allnavs :checked").each(function(e,a){if(!_.some(t.userNavs,function(e){return e.url==a.value})){t.userNavs.push({order:1,name:$.trim($(a).parent().text()),url:a.value})}});if(this.userNavs.length<=0){return}if(this.userNavs.length>5){$("#save_info").html('<div class="alert alert-danger" role="alert">鑷畾涔夎彍鍗曚笉鑳藉浜�5涓�</div>');return}var a=$(e.currentTarget);a.button("loading");this.do_save_navs(function(e,t){if(e){a.button("reset");$("#save_info").html('<div class="alert alert-danger" role="alert">鍑洪敊浜�</div>')}else{a.button("reset");if(t.success){$("#save_info").html('<div class="alert alert-success" role="alert">淇濆瓨鎴愬姛</div>')}else{$("#save_info").html('<div class="alert alert-danger" role="alert">淇濆瓨鐨勬潯浠朵笉瓒�</div>')}}})},delete_mynav:function(e){var t=$(e.currentTarget);var a=t.attr("url");var r=_.findWhere(this.userNavs,{url:a});var i=_.indexOf(this.userNavs,r);var s=this.userNavs.splice(i,1);t.button("loading");this.do_save_navs(function(e,a){if(e){t.button("reset")}else{t.button("reset");if(a.success){t.parents("td").remove()}else{}}})},do_save_navs:function(e){this.userNavSetting=this.userNavSetting||{name:"mynavs",firstkey:"mynavs",secondkey:$("#citypostcode").val()};this.userNavSetting.query=JSON.stringify(this.userNavs);var t=this.userNavSetting;var a=this;$("#save_info").empty();$.ajax({url:"/usersetting/savesetting",data:t,type:"post",dataType:"JSON",success:function(r){if(r.success){t.id=r.id;a.load_navs()}e(null,r)},error:function(){e(new Error("http error"))}})},load_navs:function(){this.userNavSetting=this.userNavSetting||{name:"mynavs",firstkey:"mynavs",secondkey:$("#citypostcode").val()};var e=this;$.ajax({url:"/usersetting/loadsetting",data:{firstkey:"mynavs",secondkey:$("#citypostcode").val()},type:"get",dataType:"JSON",cache:false,success:function(t){if(t&&t.length>0){var a=t[0];e.userNavSetting.id=a.Id;e.userNavs=JSON.parse(a.Value);e.render_navs()}else{}},error:function(){$("#save_info").html('<div class="alert alert-danger" role="alert">鍑洪敊浜�</div>')}})},render_navs:function(){var e=_.template('<li><a href="<%=url%>"><%=name%></a></li>');var t=_.template('<tr><td><%=name%></td><td><button class="btn btn-default btn-sm delete-mynav" url="<%=url%>">鍒犻櫎</button></td></tr>');$("#mynavs tbody").empty();while($("#usernavs li").length>3){$("#usernavs li:eq(1)").remove()}_.each(this.userNavs,function(a,r){$("#usernavs li:eq("+0+r+")").after(e(a));$("#mynavs tbody").append(t(a))})},show_chart:function(e){if(!e){e=$("#citypostcode").val()}$.ajax({url:"/priceindex/charthome",type:"GET",data:{postcode:e},dataType:"json",cache:false,success:function(e){$("#chart").initChart(e.series,{title:e.name,minTickInterval:1e3*60*60*24*7})}})},load_imports:function(){var e=this;$.ajax({type:"GET",url:"/caiji/today",dataType:"json",cache:false,success:function(t){_.each(t,function(t){var a=e.import_temp(t);if($('#today_imports tr[city="'+t.citycode+'"]').length>0){$('#today_imports tr[city="'+t.citycode+'"]').html(a)}else{$("#today_imports").append('<tr city="'+t.citycode+'">'+a+"</tr>")}})}})},change_tops:function(e){var t=$(e.currentTarget).attr("code");this.load_tops(t);this.show_chart(t)},load_tops:function(e){$("#top_city li.active").removeClass("active");$("#top_city").find('li[code="'+e+'"]').addClass("active");var t=this.tops_temp;$.ajax({type:"GET",url:"/priceindex/tops",data:{citypostcode:e},dataType:"json",cache:false,success:function(e){if(e){if(e.top&&e.top.length>0&&e.last&&e.last.length>0){$("#tops").html(t(e))}$("#top_date").text(e.date)}else{$("#tops,#top_date").empty()}},error:function(e,t){$("#tops,#top_date").empty()}})}});var fetch_error=function(e,t,a){alert("鍑洪敊浜唦"+t.responseText)};var City=Backbone.Model.extend({urlRoot:"/city/item",idAttribute:"PostCode",validate:function(e,t){if(!e.PostCode||!/^3\d{5}$/.test(e.PostCode)){return"璇疯緭鍏ユ纭殑閭紪"}if(!$.trim(e.Name)||!$.trim(e.Weight)){return"璇峰悕绉版垨鏉冮噸涓嶈兘涓虹┖"}if(_.isNaN(e.Weight-0)||e.Weight-0<0){return"璇疯緭鍏ユ纭殑鏉冮噸"}return}});var CityList=Backbone.Collection.extend({model:City,url:"/city/items"});var CitiesView=Backbone.View.extend({el:"#content",cities:new CityList,city:new City,city_saved:false,temp:null,initialize:function(){this.temp=_.template('<tr><td><%=PostCode%></td><td><%=Name%></td><td><%=ComputerDayIndex == 1 ? "鏄�":"鍚�"%></td><td><%=ComputerDingJiIndex == 1 ? "鏄�":"鍚�"%></td><td><button type="button" class="btn btn-default btn-xs edit" postcode="<%=PostCode%>">缂栬緫</button></td></tr>');this.listenTo(this.cities,"sync",this.render);this.listenTo(this.cities,"error",this.error);this.listenTo(this.city,"sync",this.sync_city);this.listenTo(this.city,"error",this.error);this.listenTo(this.city,"invalid",this.city_invalid);this.cities.fetch({data:{x:Math.random()}})},events:{"click .edit":"show_edit","click .new":"show_edit","click #save":"save_city","click .delete":"delete_city"},render:function(){$("#cities").empty();this.cities.each(function(e){$("#cities").append(this.temp(e.toJSON()))},this)},sync_city:function(e,t,a){$("#postcode").val(this.city.get("PostCode"));$("#name").val(this.city.get("Name"));$("#weight").val(this.city.get("Weight"));$("#layer").val(this.city.get("Layer"));$("#dayindex option:eq("+(this.city.get("ComputerDayIndex")==1?0:1)+")").prop("selected","selected");$("#dingjiindex option:eq("+(this.city.get("ComputerDingJiIndex")==1?0:1)+")").prop("selected","selected");if(this.city_saved){this.city_saved=false;$("#info").html('<div class="alert alert-success alert-dismissable"><button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button><strong>淇濆瓨鎴愬姛!</strong></div>');this.cities.fetch({data:{x:Math.random()}})}},error:function(){alert("鍑洪敊浜嗭紝璇风‘璁ゆ偍杈撳叆鐨勪俊鎭纭�")},city_invalid:function(e,t){$("#info").html('<div class="alert alert-danger alert-dismissable"><button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button><strong>鍑洪敊浜�!</strong>'+t+"</div>")},show_edit:function(e){$("#info").empty();this.city_saved=false;if($(e.currentTarget).hasClass("new")){this.city.clear();$("#postcode_contain").show();$("#postcode").val("");$("#name").val("");$("#weight").val("");$("#layer").val("3")}else{$("#postcode_contain").hide();this.city.set("PostCode",$(e.currentTarget).attr("postcode"));this.city.fetch({data:{x:Math.random()}})}$("#modal").modal("show")},save_city:function(e){$("#info").empty();this.city_saved=true;this.city.set({PostCode:$("#postcode").val(),Name:$("#name").val(),Weight:1,ComputerDayIndex:$("#dayindex").val(),ComputerDingJiIndex:$("#dingjiindex").val()});this.city.save()},delete_city:function(e){if(!confirm("纭畾瑕佸垹闄ゅ悧?")){return}var t=$(e.currentTarget).attr("postcode");var a=this;$.ajax({url:"/city/deleteitem",type:"POST",dataType:"json",data:{postcode:t},success:function(){a.cities.fetch({data:{x:Math.random()}})},error:function(){alert("鍑洪敊浜�")}})}});var Category=Backbone.Model.extend({urlRoot:"/category/item",idAttribute:"Id",validate:function(e,t){return}});var CategoryList=Backbone.Collection.extend({model:Category,url:"/category/items"});var CategoriesView=Backbone.View.extend({el:"#content",categories:new CategoryList,cities:new CityList,category:new Category,city_saved:false,temp:null,add_class_temp:null,cities_temp:null,post_code:$("#postcode").val(),initialize:function(){this.cities_temp=_.template('<li  pc="<%=PostCode%>"><a href="#<%=PostCode%>"><%=Name%></a></li>');this.listenTo(this.categories,"error",fetch_error);this.listenTo(this.category,"error",this.fetch_category_error);this.listenTo(this.categories,"sync",this.render);this.listenTo(this.category,"sync",this.fetch_category);this.categories.fetch({data:{postcode:this.post_code||"0",x:Math.random()}});this.temp=_.template($("#categories_temp").html());this.add_class_temp=_.template($("#add_class_temp").html())},events:{"click #cities li":"city_category","click .add_class_3":"show_add_class_3","click .edit_class":"show_edit_class","click #save":"save_add_class","click .edit_weight":"show_edit_weight","click #save_weight":"save_weight","click #upload_image":"upload_image"},render:function(){$("#categories").empty();var e=this.categories.toJSON();$("#categories").append(this.temp({cats:e,edit:$("#postcode").val()=="0"},is_sheng=this.post_code=="0"))},city_category:function(e){$("#cities li").removeClass("active");$(e.currentTarget).addClass("active");this.post_code=$(e.currentTarget).attr("pc");this.categories.fetch({data:{postcode:this.post_code,x:Math.random()}})},show_add_class_3:function(e){$("#info").empty();this.category.set("Id",0);this.category.set({CityPostCode:this.post_code,Code:"",Name:"",Description:"",Image:"",Measure:"",Addition1:"",Addition2:"",Addition3:"",ParentName:$(e.currentTarget).parents("ul").attr("cate"),ParentCode:$(e.currentTarget).parents("ul").attr("code")});if(this.post_code!="0"){var t=this;$.getJSON("/category/subitem",{postcode:this.post_code,parentcode:this.category.get("ParentCode")},function(e){var a=t.category.toJSON();a.news=e;$("#add_class_modal .modal-content").html(t.add_class_temp(a))})}else{$("#add_class_modal .modal-content").html(this.add_class_temp(this.category.toJSON()))}$("#add_class_modal").modal("show")},show_edit_class:function(e){var t=$(e.currentTarget).attr("cate_id");this.category.set("Id",t);var a=this;$.ajax({url:"/category/item",type:"GET",dataType:"json",data:{id:t},success:function(e){a.category.set(e);$("#add_class_modal .modal-content").html(a.add_class_temp(a.category.toJSON()));$("#add_class_modal").modal("show")}})},save_add_class:function(e){if(this.post_code=="0"){this.category.set({Code:this.category.get("Code")?this.category.get("Code"):this.category.get("ParentCode")+$("#code").val(),Name:$("#name").val(),Measure:$("#measure").val(),Description:$("#description").val(),Addition1:$("#addition1").val(),Addition2:$("#addition2").val(),Addition3:$("#addition3").val()});if(!this.category.get("Id")){this.category.unset("Id")}this.category.save()}else{var t=$("#news :checked");var a=_.map(t,function(e){return $(e).attr("code")});var r={newids:a.toString(),postcode:this.post_code};var i=this;$.post("/category/addsubitem",r,function(e){if(e.success){i.fetch_category()}else{i.fetch_category_error(null,{responseText:e.info},null)}},"json")}},fetch_category:function(e,t,a){if(this.category.get("Code")){$("#item_code").hide()}$("#info").html('<div class="alert alert-success alert-dismissable"><button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button><strong>淇濆瓨鎴愬姛!</strong></div>');this.categories.fetch({data:{postcode:this.post_code,x:Math.random()}})},fetch_category_error:function(e,t,a){$("#info").html('<div class="alert alert-danger alert-dismissable"><button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button><strong>鍑洪敊浜�!  </strong>'+t.responseText+"</div>")},show_edit_weight:function(e){var t=_.template($("#edit_weight_temp").html());$.getJSON("/category/weight",{code:$(e.currentTarget).parent().parent().attr("code"),postcode:this.post_code},function(e){$("#edit_weight_modal .modal-content").html(t(e));$("#edit_weight_modal").modal("show")})},save_weight:function(e){var t=this.post_code;var a=this;$.post("/category/weight",{postcode:t,code:$("#edit_weight_modal #category_code").val(),weight:$("#new_weight").val()},function(e){if(e.success){$("#info_weight").html('<div class="alert alert-success alert-dismissable"><button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button><strong>淇濆瓨鎴愬姛!</strong></div>');a.categories.fetch({data:{postcode:t,x:Math.random()}})}else{$("#info_weight").html('<div class="alert alert-danger alert-dismissable"><button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button><strong>鍑洪敊浜�!</strong>'+e.info+"</div>")}},"json")},upload_image:function(e){if(!$("#image").val()){$("#info").html('<div class="alert alert-danger alert-dismissable"><button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button><strong>璇烽€夋嫨鍥剧墖!  </strong></div>')}else{$("#info").empty();var t=$(e.currentTarget);t.button("loading");var a=this.category.get("Code");var r=this.category;$("#image_form").ajaxSubmit({success:function(e){t.button("reset");if(e.success){$("#image_source").attr("src",e.info);$("#image_source").parent().parent().show();r.set("Image",e.info)}else{alert("瀵煎叆澶辫触锛�"+e.info)}},error:function(e){t.button("reset");alert("瀵煎叆澶辫触")},dataType:"json",data:{category:a}})}}});var SubmitDataView=Backbone.View.extend({el:"#sub_contain",initialize:function(){$("#price_date").datepicker();$.ajax({url:"/caiji/tempdatas",type:"GET",cache:false,dataType:"json",success:function(e){if(e.length>0){$("#price_date").val(e[0].PriceDate)}_.each(e,function(e){$(':text[name="'+e.CategoryCode+'"]').val(e.Price)})},error:function(e){}})},events:{"click #sub":"sub","click #temp_save":"temp_save"},validate:function(e,t){if(!$("#price_date").val()||isNaN(Date.parse($("#price_date").val()))){t(new Error("璇疯緭鍏ユ纭～鎶ユ椂闂�"));return}$(".has-error").removeClass("has-error");var a=$("#table_data").find(":text");var r={};a.each(function(e,t){var a=$(t);var i=a.val();var s=new RegExp("^\\d+(.\\d+)?$");if(i){if(s.test(i)&&parseFloat(i)>0){r[a.attr("name")]=i}else{a.parent().addClass("has-error")}}});var i=$(".has-error").length<=0?null:new Error("濉姤鏍煎紡閿欒锛岃妫€鏌ョ孩鑹叉鐨勯儴鍒�");t(i,$("#price_date").val(),r)},show_msg:function(e,t){$("#info_modal .modal-body p").addClass(t?"text-success":"text-danger").removeClass(t?"text-danger":"text-success").html(e);$("#info_modal").modal("show")},sub:function(e){var t=this;this.validate(false,function(e,a,r){if(e){t.show_msg(e.message);return}if(_.isEmpty(r)){t.show_msg("鎮ㄦ病鏈夊～鍐欎换浣曚环鏍�");return}$.ajax({type:"POST",url:"/caiji/hand",dataType:"json",data:{dt:a,values:JSON.stringify(r)},success:function(e){t.show_msg(e.success?"濉姤鎴愬姛":e.info||"濉姤鍑洪敊",e.success)},error:function(e){t.show_msg("璇锋眰澶辫触")}})})},temp_save:function(e){var t=this;this.validate(true,function(e,a,r){if(e){t.show_msg(e);return}$.ajax({type:"POST",url:"/caiji/hand",dataType:"json",data:{dt:a,values:JSON.stringify(r),isTemp:true},success:function(e){var a="";if(!e.success){a="淇濆瓨澶辫触"+(e.info||"")}else{a="淇濆瓨鎴愬姛"}t.show_msg(a,e.success)},error:function(e){t.show_msg("璇锋眰澶辫触")}})})}});var PriceIndexView=Backbone.View.extend({el:$("#content"),events:{"click #search":"search","click #pager a":"go_page","change #start_month_year,#end_month_year":"month_change_year","change #start_month_month,#end_month_month":"month_change_month","change #start_season_year,#end_season_year":"season_change_year","change #start_season_month,#end_season_month":"season_change_month","change #start_year,#end_year":"change_year","change #start_day,#end_day,#start_week,#end_week":"change_date","click #export":"export_confirm","click .range_contu":"show_range_contu","click #import_search":"import_search","click #save_search":"save_search","click #sub_search":"sub_search","click .delete_setting":"delete_search","click .import_s_item":"import_s_item","click #ck_city :checkbox":"check_city","click #indextype :checkbox":"check_indextype","click #select_cats :checkbox":"check_cats","change #datetype":"change_datetype","change #move_type":"change_move_type","click #add_move_range":"add_move_range","click .title_order li":"title_order","click #search_chart":"show_chart"},postcode:$("#postcode").val(),initialize:function(){this.price_temp=_.template('<tr><td><%=PriceDate%></td><td><%=City%></td><td>锛�<%=CategoryCode%>锛�<%=Category%></td><td><%=Measure%></td><td><%=Price%></td><td><p class="<%if(PriceMove > 0){%>text-danger<%}else if(PriceMove < 0){%>text-success<%}%>"><%=PriceMove%></p></td><td><p class="<%if(PriceMove > 0){%>text-danger<%}else if(PriceMove < 0){%>text-success<%}%>"><%=PriceMoveRate%>%</p></td></tr>');this.import_temp=_.template("<tr><td><%=PriceDate%></td><td><%=City%></td><td>锛�<%=CategoryCode%>锛�<%=Category%></td><td><%=Measure%></td><td><%=Price%></td></tr>");this.index_temp=_.template('<tr><td><%=IndexDate%></td><td gp="category">锛�<%=CategoryCode%>锛�<%=Category%></td><td gp="indexType"><%=NameIndexType%></td><td><%=PriceIndex%></td><td class="range_contu" pi_id="<%=Id%>"><p class="<%if(IndexMove > 0){%>text-danger<%}else if(IndexMove < 0){%>text-success<%}%>"><%=IndexMoveRate%>%</p></td></tr>');this.pageTemp=_.template($("#tempPage").html());$(".dp").datepicker();$("#pp").popover({trigger:"hover"})},show_error:function(e){$("#search_info").html('<div class="alert alert-danger alert-dismissable"><button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>'+e+"</div>")},get_query:function(){var e={};var t=[];$("#ck_city :checked[value]").each(function(e,a){t.push($(a).val())});if(t.length==0){this.show_error("璇烽€夋嫨鍦板尯");return false}else{e.diqu=t}e.datetype=$("#datetype").val();var a=new RegExp("^\\d{4}-\\d{2}-\\d{2}$");if($(".start").val()&&!a.test($(".start").val())){this.show_error("寮€濮嬫椂闂存牸寮忛敊璇紝璇烽噸鏂伴€夋嫨");return false}else{e.start=$(".start").val()}if($(".end").val()&&!a.test($(".end").val())){this.show_error("缁撴潫鏃堕棿鏍煎紡閿欒锛岃閲嶆柊閫夋嫨");return false}else{e.end=$(".end").val()}var r=[];$("#select_cats :checked[value]").each(function(e,t){r.push($(t).val())});if(r.length==0){this.show_error("璇烽€夋嫨鍒嗙被");return false}else{e.category=r}var i=[];$("#zhibiao .checkbox :checked[value]").each(function(e,t){i.push($(t).val())});if(i.length==0){this.show_error("璇烽€夋嫨鎸囨爣绫诲瀷");return false}else{e.zhibiao=i}e.order=$("#order").val();e.moveRange=[];$("#temp_add_rage_contain .index-range").each(function(t,a){var r=$(a);var i=r.find(':hidden[name="index_type"]').val();var s={zhibiao:r.find(':hidden[name="index_type"]').val(),zhibiaoName:$("#move_type").find('option[value="'+i+'"]').text(),low:parseFloat(r.find(".low").val()),hight:parseFloat(r.find(".hight").val()),moveLow:parseFloat(r.find(".move_low").val()),moveHight:parseFloat(r.find(".move_hight").val()),moveRateLow:parseFloat(r.find(".move_rate_low").val()),moveRateHight:parseFloat(r.find(".move_rate_hight").val())};e.moveRange.push(s)});$("#search_info").empty();return e},display_params:function(e){var t=_.template("<strong><%=name%>:</strong><%=value%>&nbsp;&nbsp;");var a="";if(this.postcode=="0"){if(this.datatype=="price"){$("#table_head th").show()}else{a+=t({name:"鍩庡競",value:e.display_postcode})}}else{a+=t({name:"鍩庡競",value:e.display_postcode})}if(e.display_category){a+=t({name:"鍒嗙被",value:e.display_category})}if(e.indexType&&e.indexType!=-1){a+=t({name:"鎸囨暟绫诲瀷",value:$('#indextype option[value="'+e.indexType+'"]').text()})}if(e.start){a+=t({name:"寮€濮嬫椂闂�",value:e.start})}if(e.end){a+=t({name:"缁撴潫鏃堕棿",value:e.end})}if(e.low&&!isNaN(e.low)){a+=t({name:"鏈€浣庝环鏍�",value:e.low})}if(e.hight&&!isNaN(e.hight)){a+=t({name:"鏈€楂樹环鏍�",value:e.hight})}if(e.move_low&&!isNaN(e.move_low)){a+=t({name:"鏈€浣庢定璺屽€�",value:e.move_low})}if(e.move_hight&&!isNaN(e.move_hight)){a+=t({name:"鏈€楂樻定璺屽€�",value:e.move_hight})}if(e.move_rate_low&&!isNaN(e.move_rate_low)){a+=t({name:"鏈€浣庢定璺屽箙",value:e.move_rate_low})}if(e.move_rate_hight&&!isNaN(e.move_rate_hight)){a+=t({name:"鏈€楂樻定璺屽箙",value:e.move_rate_hight})}if(a){var r='<div class="alert alert-info alert-dismissable"><strong>銆愭煡璇㈡潯浠躲€�</strong>'+a+"</div>";$("#search_info").html(r)}},search:function(e){var t=this.get_query();if(!t){return}var a=$(e.currentTarget);a.button("loading");var r=this;$.ajax({url:"/priceindex/list",type:"POST",dataType:"json",data:{query:JSON.stringify(t)},success:function(e){r.query=e.query;r.get_index_title(e.results);r.pageindex=e.pageindex;r.pagesize=e.pagesize;r.totalpage=e.totalpage;r.render_result(e.results);a.button("reset")},error:function(){}})},go_page:function(e){e.preventDefault();e.stopPropagation();var t=$(e.currentTarget).attr("href");if(t.length<=6){return}else{t=t.substr(6);var a=this;$.ajax({url:"/priceindex/list",type:"POST",dataType:"json",data:{query:JSON.stringify(a.query),pageindex:t},success:function(e){a.query=e.query;a.pageindex=e.pageindex;a.pagesize=e.pagesize;a.totalpage=e.totalpage;a.render_result(e.results)},error:function(){}})}},title_order:function(e){var t=$(e.currentTarget);var a=t.parent().attr("code");var r=t.attr("order");this.query.order=a+"_"+r+"_"+this.query.order;var i=this;var s=r=="asc"?"glyphicon-arrow-up":"glyphicon-arrow-down";$("#table_head span.glyphicon").removeClass("glyphicon-arrow-up").removeClass("glyphicon-arrow-down");var n=t.parent().parent().parent().find(".glyphicon").addClass(s);$.ajax({url:"/priceindex/list",type:"POST",dataType:"json",data:{query:JSON.stringify(i.query),pageindex:1},success:function(e){i.query=e.query;i.pageindex=e.pageindex;i.pagesize=e.pagesize;i.totalpage=e.totalpage;i.render_result(e.results)},error:function(){}})},render_result:function(e){var t="<tr><td><%=Round%></td><td><%=CityName%></td><td><%=CategoryName%></td>";if(this.query.zhibiao.indexOf("Price")>=0){t+="<td><%=Price%></td><td><%=PriceMove%></td><td><%=PriceMoveRate%></td>"}var a="";if(this.query.zhibiao.indexOf("PriceIndex0")>=0){a="<%=Comments.indexOf('0') >= 0 ? 'text-warning' : ''%>";t+='<td class=" '+a+'"><%=PriceIndex0%></td><td class=" '+a+'"><%=IndexMove0%></td><td class=" '+a+'"><%=IndexMoveRate0%></td>'}if(this.query.zhibiao.indexOf("PriceIndex1")>=0){a="<%=Comments.indexOf('1') >= 0 ? 'text-warning' : ''%>";t+='<td class=" '+a+'"><%=PriceIndex1%></td><td><%=PriceIndex1?(PriceIndex1-100).toFixed(2,10):""%></td><td class=" '+a+'"><%=IndexMove1%></td><td class=" '+a+'"><%=IndexMoveRate1%></td>'}if(this.query.zhibiao.indexOf("PriceIndex2")>=0){a="<%=Comments.indexOf('2') >= 0 ? 'text-warning' : ''%>";t+='<td class=" '+a+'"><%=PriceIndex2%></td><td><%=PriceIndex2?(PriceIndex2-100).toFixed(2,10):""%></td><td class=" '+a+'"><%=IndexMove2%></td><td class=" '+a+'"><%=IndexMoveRate2%></td>'}if(this.query.zhibiao.indexOf("QiaoWeiIndex")>=0){t+="<td><%=QiaoWeiIndex%></td>"}if(this.query.zhibiao.indexOf("QiaoWeiIndexGx")>=0){t+="<td><%=QiaoWeiIndexGx%></td>"}if(this.query.zhibiao.indexOf("XinZengIndex")>=0){t+="<td><%=XinZengIndex%></td>"}if(this.query.zhibiao.indexOf("XinZengIndexGx")>=0){t+="<td><%=XinZengIndexGx%></td>"}t+="</tr>";var r=_.template(t);$("#table_content").empty();_.each(e,function(e){var t=r(e);$("#table_content").append(t)});$("#pager").html(this.pageTemp({page:this.pageindex,totalPage:this.totalpage}))},get_index_title:function(e){var t="<tr><th>鏃堕棿</th><th>鍩庡競</th><th>鍒嗙被</th>";var a=_.template('<th><span class="dropdown"><span data-toggle="dropdown" ><%if(small){%><small><%=name%></small><%}else{%><%=name%><%}%></span><ul class="dropdown-menu title_order" role="menu" aria-labelledby="dLabel" code="<%=code%>"><li order="asc"><a href="javascript:void(0)">鎸�<%=name%>鍗囧簭</a></li><li order="desc"><a href="javascript:void(0)">鎸�<%=name%>闄嶅簭</a></li></ul></span><span class="glyphicon"></span></th>');if(this.query.zhibiao.indexOf("Price")>=0){t+=a({code:"Price",name:"浠锋牸",small:false});t+=a({code:"PriceMove",name:"娑ㄨ穼鍊�",small:true});t+=a({code:"PriceMoveRate",name:"娑ㄨ穼骞�",small:true})}if(this.query.zhibiao.indexOf("PriceIndex0")>=0){t+=a({code:"PriceIndex0",name:"瀹氬熀",small:false});t+=a({code:"IndexMove0",name:"鎸囨暟娑ㄨ穼鍊�",small:true});t+=a({code:"IndexMoveRate0",name:"鎸囨暟娑ㄨ穼骞�",small:true})}if(this.query.zhibiao.indexOf("PriceIndex1")>=0){t+=a({code:"PriceIndex1",name:"鐜瘮",small:false});t+="<th><small>鍩哄噯涓�100娑ㄨ穼鍊�</small></th>";t+=a({code:"IndexMove1",name:"鎸囨暟娑ㄨ穼鍊�",small:true});t+=a({code:"IndexMoveRate1",name:"鎸囨暟娑ㄨ穼骞�",small:true})}if(this.query.zhibiao.indexOf("PriceIndex2")>=0){t+=a({code:"PriceIndex2",name:"鍚屾瘮",small:false});t+="<th><small>鍩哄噯涓�100娑ㄨ穼鍊�</small></th>";t+=a({code:"IndexMove2",name:"鎸囨暟娑ㄨ穼鍊�",small:true});t+=a({code:"IndexMoveRate2",name:"鎸囨暟娑ㄨ穼骞�",small:true})}if(this.query.zhibiao.indexOf("QiaoWeiIndex")>=0){t+=a({code:"QiaoWeiIndex",name:"缈樺熬鍥犵礌",small:false})}if(this.query.zhibiao.indexOf("QiaoWeiIndexGx")>=0){t+=a({code:"QiaoWeiIndexGx",name:"缈樺熬璐＄尞",small:false})}if(this.query.zhibiao.indexOf("XinZengIndex")>=0){t+=a({code:"XinZengIndex",name:"鏂版定浠峰洜绱�",small:false})}if(this.query.zhibiao.indexOf("XinZengIndexGx")>=0){t+=a({code:"XinZengIndexGx",name:"鏂版定浠疯础鐚€�",small:false})}t+="</tr>";$("#table_head").html(t)},export_confirm:function(e){var t=this.get_query();if(!t){return}$.post("/priceindex/exportconfirm",{query:JSON.stringify(t)},function(e){if(e.count<=0){alert("娌℃湁鏁版嵁")}else{if(confirm("鍏辨湁"+e.count+"鏉℃暟鎹紝纭瀵煎嚭鍒癊xcel锛�")){$('#download_form :hidden[name="query"]').val(JSON.stringify(t));$("#download_form").submit()}}})},show_range_contu:function(e){$("#range_modal .modal-content").html('<img src="/content/images/loading.gif" style="display: block;margin: 0 auto;padding:15px 0;" />');$("#range_modal").modal("show");var t=$(e.currentTarget).attr("pi_id");$.getJSON("/priceindex/rangecontribute",{priceindexid:t},function(e){var t=_.template($("#temp_range").html());$("#range_modal .modal-content").html(t({model:e}))})},month_change_year:function(e){var t=$(e.currentTarget);var a=t.attr("id").split("_")[0];if(!t.val()||t.val()==""){var r=a+"_month_month";$("#"+r).find("option:eq(0)").attr("selected","selected");$("."+a).val("")}else{var i=t.attr("id").substring(0,t.attr("id").lastIndexOf("_"))+"_month";if($("#"+i).val()&&$("#"+i).val()!=""){var s=t.val()+"-"+$("#"+i).val()+"-01";$("."+a).val(s)}}},month_change_month:function(e){var t=$(e.currentTarget);var a=t.attr("id").split("_")[0];if(!t.val()||t.val()==""){$("."+a).val("")}else{var r=t.attr("id").substring(0,t.attr("id").lastIndexOf("_"))+"_year";if($("#"+r).val()&&$("#"+r).val()!=""){var i=$("#"+r).val()+"-"+t.val()+"-01";$("."+a).val(i)}}},season_change_year:function(e){var t=$(e.currentTarget);var a=t.attr("id").split("_")[0];if(!t.val()||t.val()==""){var r=a+"_season_month";$("#"+r).find("option:eq(0)").attr("selected","selected");$("."+a).val("")}else{var i=t.attr("id").substring(0,t.attr("id").lastIndexOf("_"))+"_month";if($("#"+i).val()&&$("#"+i).val()!=""){var s=t.val()+"-"+$("#"+i).val()+"-01";$("."+a).val(s)}}},season_change_month:function(e){var t=$(e.currentTarget);var a=t.attr("id").split("_")[0];if(!t.val()||t.val()==""){$("."+a).val("")}else{var r=t.attr("id").substring(0,t.attr("id").lastIndexOf("_"))+"_year";if($("#"+r).val()&&$("#"+r).val()!=""){var i=$("#"+r).val()+"-"+t.val()+"-01";$("."+a).val(i)}}},change_year:function(e){var t=$(e.currentTarget);var a=t.attr("id").split("_")[0];if(!t.val()||t.val()==""){$("."+a).val("")}else{$("."+a).val(t.val()+"-12-01")}},change_date:function(e){if($(e.currentTarget).attr("id").indexOf("end")>=0){$(".end").val($(e.currentTarget).val())}else{$(".start").val($(e.currentTarget).val())}},import_search:function(e){$("#import_modal").modal("show");this.load_search()},load_search:function(){var e={firstkey:"zhibiaoquery",secondkey:"zhibiaoquery"};$.ajax({url:"/usersetting/loadsetting",data:e,type:"get",dataType:"JSON",success:function(e){$("#settings").empty();_.each(e,function(e){$("#settings").append('<tr s_id="'+e.Id+'"><td>'+e.Name+"</td><td>"+e.CreateAt+'</td><td><button type="button" class="btn btn-primary btn-sm import_s_item">瀵煎叆</button>  <button type="button" class="btn btn-default btn-sm delete_setting">鍒犻櫎</button></td></tr>')})},error:function(){}})},save_search:function(e){var t=this.get_query();if(t){$("#save_new_name").text("");$("#save_info").text("");$("sub_search").button("reset").removeAttr("save_id");$("#save_modal").modal("show")}},sub_search:function(e){var t=$(e.currentTarget);var a=this.get_query();var r=$.trim($("#save_new_name").val());if(!r){$("#save_info").html('<div class="alert alert-danger" role="alert">璇疯緭鍏ュ娉ㄥ悕绉帮紝鏂逛究璁板繂</div>');return}if(t.attr("save_id")){$("#save_info").html('<div class="alert alert-success" role="alert">宸茬粡淇濆瓨鎴愬姛</div>');return}$("#save_info").empty();if(a){t.button("loading");var i=JSON.stringify(a);var s={name:r,firstkey:"zhibiaoquery",secondkey:"zhibiaoquery",query:i};$.ajax({url:"/usersetting/savesetting",data:s,type:"post",dataType:"JSON",success:function(e){if(e.success){$("#save_info").html('<div class="alert alert-success" role="alert">淇濆瓨鎴愬姛</div>');t.attr("save_id",e.id).button("saved")}else{$("#save_info").html('<div class="alert alert-danger" role="alert">淇濆瓨鐨勬潯浠朵笉瓒�</div>');t.button("reset")}},error:function(){$("#save_info").html('<div class="alert alert-danger" role="alert">鍑洪敊浜�</div>');t.button("reset")}})}},delete_search:function(e){var t=$(e.currentTarget).parents("tr");var a=t.attr("s_id");$.ajax({url:"/usersetting/deletesetting",data:{id:a},dataType:"JSON",type:"POST",success:function(e){t.remove()}})},import_s_item:function(e){var t=$(e.currentTarget).parents("tr:eq(0)").attr("s_id");var a=this;$.ajax({url:"/usersetting/loadsetting",data:{id:t},dataType:"JSON",type:"get",success:function(e){if(e){var t=JSON.parse(e.Value);$("#order").find('option[value="'+t.order+'"]').prop("selected","selected");$("#datetype").val(t.datetype).change();if(t.start){$(".start").val(t.start)}if(t.end){$(".end").val(t.end)}if(t.datetype=="day"){if(t.start){$("#start_day").val(t.start)}if(t.end){$("#end_day").val(t.end)}}else if(t.datetype=="week"){if(t.start){$("#start_week").val(t.start)}if(t.end){$("#end_week").val(t.end)}}else if(t.datetype=="month"){$("#start_month_year,#start_month_month,#end_month_year,#end_month_month").find("option:eq(0)").prop("selected","selected");if(t.start){$('#start_month_year option[value="'+t.start.substr(0,4)+'"]').prop("selected","selected");$('#start_month_month option[value="'+t.start.substr(5,2)+'"]').prop("selected","selected")}if(t.end){$('#end_month_year option[value="'+t.end.substr(0,4)+'"]').prop("selected","selected");$('#end_month_month option[value="'+t.end.substr(5,2)+'"]').prop("selected","selected")}}else if(t.datetype=="season"){$("#start_season_year,#start_season_month,#end_season_year,#end_season_month").find("option:eq(0)").prop("selected","selected");if(t.start){$('#start_season_year option[value="'+t.start.substr(0,4)+'"]').prop("selected","selected");$('#start_season_month option[value="'+t.start.substr(5,2)+'"]').prop("selected","selected")}if(t.end){
$('#end_season_year option[value="'+t.end.substr(0,4)+'"]').prop("selected","selected");$('#end_season_month option[value="'+t.end.substr(5,2)+'"]').prop("selected","selected")}}else if(t.datetype=="year"){$("#start_year,#end_year").find("option:eq(0)").prop("selected","selected");if(t.start){$('#start_year option[value="'+t.start.substr(0,4)+'"]').prop("selected","selected")}if(t.end){$('#end_year option[value="'+t.start.substr(0,4)+'"]').prop("selected","selected")}}$("#ck_city :checkbox").prop("checked",false);_.each(t.diqu,function(e){$('#ck_city :checkbox[value="'+e+'"]').prop("checked",true)});$("#select_cats :checkbox").prop("checked",false);_.each(t.category,function(e){$('#select_cats :checkbox[value="'+e+'"]').prop("checked",true)});$("#zhibiao :checkbox").prop("checked",false);_.each(t.zhibiao,function(e){$('#zhibiao :checkbox[value="'+e+'"]').prop("checked",true)});$("#temp_add_rage_contain").empty();var a=_.template($("#temp_add_rage").html());_.each(t.moveRange,function(e){var t={index_type:e.zhibiao,index_type_name:e.zhibiaoName,low:e.low,hight:e.hight,move_low:e.moveLow,move_hight:e.moveHight,move_rate_low:e.moveRateLow,move_rate_hight:e.moveRateHight};$("#temp_add_rage_contain").append(a(t))});$("#import_modal").modal("hide");$("#search").click()}}})},check_city:function(e){var t=$(e.currentTarget);if(t.index($("#ck_city :checkbox"))==0){if(t.prop("checked")){$("#ck_city :checkbox:gt(0)").prop("checked",true)}else{$("#ck_city :checkbox:gt(0)").prop("checked",false)}}else{$("#ck_all_city").prop("checked",false)}},check_indextype:function(e){var t=$(e.currentTarget);if(t.index($("#indextype :checkbox"))==0){if(t.prop("checked")){$("#indextype :checkbox:gt(0)").prop("checked",true)}else{$("#indextype :checkbox:gt(0)").prop("checked",false)}}else{$("#indextype :checkbox:eq(0)").prop("checked",false)}},check_cats:function(e){var t=$(e.currentTarget);if(t.val()=="-1"){if(t.prop("checked")){$("#select_cats :checkbox").prop("checked",true)}else{$("#select_cats :checkbox").prop("checked",false)}}else if(t.val()=="0"){if(!t.prop("checked")){$("#select_cats :checkbox:eq(0)").prop("checked",false)}}else{var a=t.parent().next().find(":checkbox");if(t.prop("checked")){}else{a.prop("checked",false);$("#select_cats :checkbox:eq(0)").prop("checked",false)}}},change_datetype:function(e){var t=$(e.currentTarget).find("option:selected").attr("value");$(":hidden.start,:hidden.end").val("");$("#date_day,#date_week,#date_month,#date_season,#date_year").addClass("hidden");$("#date_"+t).removeClass("hidden")},change_move_type:function(e){var t=$(e.currentTarget);if(t.val()=="QiaoWeiIndex"||t.val()=="XinZengIndex"){$(".move-contain,.move-rate-contain").hide()}else{$(".move-contain,.move-rate-contain").show()}},add_move_range:function(e){var t=$("#move_type").val();var a=false;$('.index-range :hidden[name="index_type"]').each(function(e,r){if($(r).val()==t){a=true;return}});if(a){return}var r=parseFloat($("#low").val()),i=parseFloat($("#hight").val()),s=parseFloat($("#move_low").val()),n=parseFloat($("#move_hight").val()),o=parseFloat($("#move_rate_low").val()),c=parseFloat($("#move_rate_hight").val());var d={index_type:t,index_type_name:$("#move_type option:selected").text(),low:r,hight:i,move_low:s,move_hight:n,move_rate_low:o,move_rate_hight:c};var l=_.template($("#temp_add_rage").html());if(t=="QiaoWeiIndex"||t=="XinZengIndex"){if(r&&!isNaN(r)||i&&!isNaN(i)){$("#temp_add_rage_contain").append(l(d))}}else{if(r&&!isNaN(r)||i&&!isNaN(i)||s&&!isNaN(s)||n&&!isNaN(n)||o&&!isNaN(o)||c&&!isNaN(c)){$("#temp_add_rage_contain").append(l(d))}}},show_chart:function(e){var t=this.get_query();if(!t){return}var a=t.zhibiao.length*t.diqu.length*t.category.length;if(a>5){if(!confirm("鎮ㄦ煡璇㈢殑瓒嬪娍鍥炬湁鍏�"+a+"鏈夋潯绾挎潯鍙兘浼氶€犳垚娴忚鍣ㄥ崱浣忥紝鏄惁缁х画锛�")){return}}var r=this;if(r.chart){r.chart.showLoading()}$.ajax({url:"/priceindex/chartdata",type:"POST",dataType:"json",data:{query:JSON.stringify(t)},success:function(e){if(!r.chart){r.chart=$("#chart").initChart(e.series,{title:e.name,minTickInterval:1e3*60*60*24*30})}else{r.chart.hideLoading();while(r.chart.series.length>0)r.chart.series[0].remove();for(var t=0;t<e.series.length;t++){r.chart.addSeries(e.series[t])}}}})}});var Cate=Backbone.Model.extend({urlRoot:"/category/item",idAttribute:"Id"});var CateList=Backbone.Collection.extend({model:Cate,url:"/category/allcates",get_cates:function(e){this.fetch({data:{postcode:e,x:Math.random()}})}});var RowColList=Backbone.Collection.extend({});var PriceIndexDView=Backbone.View.extend({el:$("#content"),events:{"click #add_row,#add_col":"show_modal","click #sl_all_city":"sl_all_city",'click :checkbox[name="cate"]':"ch_cat","click button.add_rc":"add_rc","click #search":"search","click #export":"export_excel","click #empty_select":"empty_select","click #show_save_search":"show_save_search","click #sub_search":"save_search","click #load_search":"load_search","click .delete_setting":"delete_search","click .import_s_item":"import_s_item"},cate_list:new CateList,rows:new RowColList,cols:new RowColList,initialize:function(){this.listenTo(this.cate_list,"sync",this.render_cates);this.cate_list.get_cates("0");this.cate_template=_.template($("#tempCates").html());this.listenTo(this.rows,"add",this.render_row);this.listenTo(this.cols,"add",this.render_col);$.getJSON("/city/items",function(e){_.each(e,function(e){$("#add_city ul").append('<li class="col-xs-2"> <label><input type="checkbox" name="city"  value="'+e.PostCode+'" d="'+e.Name+'"/>'+e.Name+"</label></li>")})});$(".dp").datepicker()},empty_select:function(){if(this.add_type=="rows"){$("#tb_header").empty();this.rows.reset()}else{$("#tb_body").empty();this.cols.reset()}},render_row:function(e){var t=1;for(var a=this.rows.length;a>0;a--){var r=$("#tb_header tr:eq("+(a-1)+")");r.find("th:gt(0)").prop("colspan",t);t=this.rows.at(a-1).get("group_values").length*t}var i="<tr>";i+='<th colspan="'+this.cols.length+'"></th>';var s=1;for(var a=0;a<this.rows.length-1;a++){s=this.rows.at(a).get("group_values").length*s}var n=s;for(var o=0;o<n;o++){_.each(e.get("group_values"),function(e){i+="<th>"+e.name+"</th>"},this)}i+="</tr>";$("#tb_header").append(i);if($("#tb_body tr:first td").length>0&&$("#tb_body tr:first td").length-this.cols.length!=t){var c=t-($("#tb_body tr:first td").length-this.cols.length);if(c>0){for(var d=0;d<c;d++){$("#tb_body tr").append("<td></td>")}}else{for(var l=c;l<0;l++){$("#tb_body tr td:last").remove()}}}},render_col:function(e){_.each(e.get("group_values"),function(e,t){if(t==0&&this.cols.length!=1){var a=$('#tb_body td[c="'+(this.cols.length-1)+'"]');a.after('<td class="td-nowrap" c='+this.cols.length+" g="+t+">"+e.name+"</td>");var r=1;for(var i=this.cols.length;i>0;i--){var s=$('#tb_body td[c="'+i+'"]');s.prop("rowspan",r);r=this.cols.at(i-1).get("group_values").length*r}}if(this.cols.length==1||t!=0){var n='<tr class="td-nowrap" c='+this.cols.length+" g="+t+">";n+='<td class="td-nowrap" c='+this.cols.length+" g="+t+">"+e.name+"</td>";var o=$("#tb_header tr:last th:gt(0)").length;for(var c=0;c<o;c++){n+="<td></td>"}n+="</tr>";if(this.cols.length==1){$("#tb_body").append(n)}else{var d=$('#tb_body td[c="'+this.cols.length+'"][g="'+(t-1)+'"]');if(d.length>0){d.parent().after(n)}}}},this);$("#tb_header tr").each(function(e){});_.each($("#tb_header tr"),function(e){$(e).find("th:eq(0)").prop("colspan",this.cols.length)},this)},show_modal:function(e){$("#select_col_modal").modal("show");if(e.currentTarget.id.indexOf("row")>0){this.add_type="rows";$("#select_col_modal .modal-title").text("閫夋嫨澶撮儴鏄剧ず鐨勬暟鎹�")}else{this.add_type="cols";$("#select_col_modal .modal-title").text("閫夋嫨宸︿晶鏄剧ず鐨勬暟鎹�")}},render_cates:function(){$("#add_category").append('<div><input type="checkbox" name="cate" value="0" d="鎬绘寚鏁�" />&nbsp;&nbsp;<a href="#">鎬绘寚鏁�</a></div>');this.cate_list.each(function(e){$("#add_category").append(this.cate_template(e.toJSON()))},this)},sl_all_city:function(e){if($(e.currentTarget).is(":checked")){$(':checkbox[name="city"]:not(#sl_all_city)').prop("checked","checked")}else{$(':checkbox[name="city"]:not(#sl_all_city)').removeAttr("checked")}},ch_cat:function(e){},show_error:function(e){if(e=="hide"){$("#select_col_modal .modal-body .alert-danger").remove()}else{var t='<div class="alert alert-danger alert-dismissable"><button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button><p>'+e+"</p></div>";$("#select_col_modal .modal-body").prepend(t)}},add_rc:function(e){var t=$(e.currentTarget).attr("rc");var a=$("#add_"+t);var r=t.indexOf("_")>0?t.substr(0,t.indexOf("_")):t;var i=this.rows.some(function(e){return e.get("group_name").indexOf(r)>=0});var s=this.cols.some(function(e){return e.get("group_name").indexOf(r)>=0});if(i||s){this.show_error("浣犲凡缁忔坊鍔犺繃浜嗚绫诲瀷鐨勯€夋嫨锛屽瑕侀噸鏂版坊鍔犺娓呯┖琛屾垨鑰呭垪涔嬪悗鍐嶉噸鏂版坊鍔�");return}this.show_error("hide");var n={group_name:t,group_values:[]};if(r=="city"){n.group_values=a.find(":checked").map(function(){if($(this).val()){return{name:$(this).attr("d"),key:$(this).val()}}})}else if(r=="category"){var o=":checked";var c=this.dataType;n.group_values=a.find(o).map(function(){if($(this).val()){return{name:$(this).attr("d")+"锛�"+$(this).val()+"锛�",key:$(this).val()}}})}else if(r=="indextype"){n.group_values=a.find(":checked").map(function(){if($(this).val()){return{name:$(this).attr("d"),key:$(this).val()}}})}else if(r=="time"){var d=t.substr(5);if(d=="day"){var l=new RegExp("^\\d{4}-\\d{2}-\\d{2}");var h=$("#start_day").val();if(!h||!l.test(h)){this.show_error("璇烽€夋嫨寮€濮嬫椂闂�");return}var u=$("#end_day").val();if(!u||!l.test(u)){this.show_error("璇烽€夋嫨缁撴潫鏃堕棿");return}var o=Date.parse(h);var p=Date.parse(u);for(var _=o;_<=p;_=_+1e3*60*60*24){var c=new Date(_);var v=c.getFullYear()+"-"+(c.getMonth()+1<10?"0"+(c.getMonth()+1):c.getMonth()+1)+"-"+(c.getDate()<10?"0"+c.getDate():c.getDate());n.group_values.push({name:v,key:v})}}else if(d=="week"){var l=new RegExp("^\\d{4}-\\d{2}-\\d{2}");var h=$("#start_week").val();if(!h||!l.test(h)){this.show_error("璇烽€夋嫨寮€濮嬫椂闂�");return}var u=$("#end_week").val();if(!u||!l.test(u)){this.show_error("璇烽€夋嫨缁撴潫鏃堕棿");return}var o=Date.parse(h);var p=Date.parse(u);var m;for(var _=o;_<=p;_=_+1e3*60*60*24){var c=new Date(_);if(c.getDay()==0){m=Date.parse(c);break}}if(m){for(var _=m;_<=p;_=_+1e3*60*60*24*7){var c=new Date(_);var v=c.getFullYear()+"-"+(c.getMonth()+1<10?"0"+(c.getMonth()+1):c.getMonth()+1)+"-"+(c.getDate()<10?"0"+c.getDate():c.getDate());var f=new Date(_-1e3*60*60*24*6);var g=f.getFullYear()+"-"+(f.getMonth()+1<10?"0"+(f.getMonth()+1):f.getMonth()+1)+"-"+(f.getDate()<10?"0"+f.getDate():f.getDate())+" - "+v;n.group_values.push({name:g,key:v})}}}else if(d=="month"){if(!$("#start_month_year").val()||!$("#start_month_month").val()||!$("#end_month_year").val()||!$("#end_month_month").val()){this.show_error("璇烽€夋嫨寮€濮嬪拰缁撴潫鏃ユ湡")}var y=parseInt($("#start_month_year").val()),b=parseInt($("#start_month_month").val());var x=parseInt($("#end_month_year").val()),w=parseInt($("#end_month_month").val());for(var _=y;_<=x;_++){for(var k=_==y?b:1;k<=(_==x?w:12);k++){n.group_values.push({name:_+"骞�"+k+"鏈�",key:_+"-"+(k<10?"0"+k:k)+"-01"})}}}else if(d=="season"){if(!$("#start_season_year").val()||!$("#start_season_month").val()||!$("#end_season_year").val()||!$("#end_season_month").val()){this.show_error("璇烽€夋嫨寮€濮嬪拰缁撴潫鏃ユ湡")}var T=parseInt($("#start_season_year").val()),C=parseInt($("#start_season_month").val());var N=parseInt($("#end_season_year").val()),I=parseInt($("#end_season_month").val());for(var _=T;_<=N;_++){for(var k=_==T?C:1;k<=(_==N?I:4);k++){n.group_values.push({name:_+"骞�"+k+"瀛ｅ害",key:_+"-"+(k*3<10?"0"+k*3:k*3)+"-01"})}}}else if(d=="year"){if(!$("#start_year").val()||!$("#end_year").val()){this.show_error("璇烽€夋嫨寮€濮嬪拰缁撴潫鏃ユ湡")}var j=parseInt($("#start_year").val()),O=parseInt($("#end_year").val());for(var _=j;_<=O;_++){n.group_values.push({name:_+"骞�",key:_+"-12-01"})}}}if(n.group_values.length>0){this[this.add_type].add(n)}else{this.show_error("娌℃湁鏁版嵁锛岃纭鏌ヨ鐨勬潯浠�")}},search:function(e){var t=this.get_top_left();if(!t){$("#search_error").show();return}$("#search_error").hide();var a=$(e.currentTarget);a.button("loading");var r=[];_.each(t.top,function(e,t){var a=[];var i=[];if(r.length>0){_.each(r,function(t){_.each(e.v,function(r){var i=_.clone(t);i[e.k]=r;a.push(i)})});r=a}else{_.each(e.v,function(t){var a={};a[e.k]=t;i.push(a)});r=i}});var i=[];_.each(t.left,function(e,t){var a=[];var r=[];if(i.length>0){_.each(i,function(t){_.each(e.v,function(r){var i=_.clone(t);i[e.k]=r;a.push(i)})});i=a}else{_.each(e.v,function(t){var a={};a[e.k]=t;r.push(a)});i=r}});var s="/priceindex/dlist";$.ajax({url:s,type:"POST",dataType:"json",data:{top:JSON.stringify(t.top),left:JSON.stringify(t.left)},success:function(e){var t=r.length;var s=i.length;var n=0;$("#tb_body td:not([c])").empty();$("#tb_body td:not([c])").each(function(s,o){a.button("reset");var c=parseInt(s/t);var d=s%t;var l=e[n];if(!l){return}var h=i[c];var u=r[d];var p=true;for(var _ in h){if(h[_]!=l[_.split("_")[0]]){p=false}}for(var v in u){if(u[v]!=l[v.split("_")[0]]){p=false}}if(p){if(e[n].value){$(o).text(e[n].value).attr("title","鎸囨爣锛�"+e[n].value+"  娑ㄨ穼锛�("+e[n].move+"/"+e[n].moverate+"%)")}n++}})},error:function(){a.button("reset");alert("鍑洪敊浜�")},traditional:true})},export_excel:function(e){var t=this.get_top_left();if(!t){return}var a="/priceindex/dlisttoexcel?top=";window.open(a+JSON.stringify(t.top)+"&left="+JSON.stringify(t.left))},get_top_left:function(){var e=[],t=[];this.rows.each(function(t){var a=[];_.each(t.get("group_values"),function(e){a.push(e.key)});e.push({k:t.get("group_name"),v:a})});this.cols.each(function(e){var a=[];_.each(e.get("group_values"),function(e){a.push(e.key)});t.push({k:e.get("group_name"),v:a})});if(t.length==0||e.length==0){return false}else if(this.dataType=="price"&&t.length+e.length<3){return false}else if(this.dataType=="priceindex"&&t.length+e.length<4){return false}else{return{top:e,left:t}}},show_save_search:function(e){var t=this.get_top_left();if(!t){$("#search_error").show();return}$("#save_modal").modal("show")},save_search:function(e){var t=$(e.currentTarget);var a=$.trim($("#save_new_name").val());if(!a){$("#save_info").html('<div class="alert alert-danger" role="alert">璇疯緭鍏ュ娉ㄥ悕绉帮紝鏂逛究璁板繂</div>');return}if(t.attr("save_id")){$("#save_info").html('<div class="alert alert-success" role="alert">宸茬粡淇濆瓨鎴愬姛</div>');return}t.button("loading");var r=function(e){var t=[];for(var a=0;a<e.length;a++){var r={group_name:e[a].group_name,group_values:[]};for(var i=0;i<e[a].group_values.length;i++){var s={key:e[a].group_values[i].key,name:e[a].group_values[i].name};r.group_values.push(s)}t.push(r)}return t};var i={rows:r(this.rows.toJSON()),cols:r(this.cols.toJSON())};var s={name:a,firstkey:"dlist",secondkey:"dlist",query:JSON.stringify(i)};$.ajax({url:"/usersetting/savesetting",data:s,type:"post",dataType:"JSON",success:function(e){if(e.success){$("#save_info").html('<div class="alert alert-success" role="alert">淇濆瓨鎴愬姛</div>');t.attr("save_id",e.id).button("saved")}else{$("#save_info").html('<div class="alert alert-danger" role="alert">淇濆瓨鐨勬潯浠朵笉瓒�</div>');t.button("reset")}},error:function(){$("#save_info").html('<div class="alert alert-danger" role="alert">鍑洪敊浜�</div>');t.button("reset")}})},load_search:function(){$("#import_modal").modal("show");var e={firstkey:"dlist",secondkey:"dlist"};$.ajax({url:"/usersetting/loadsetting",data:e,type:"get",dataType:"JSON",success:function(e){$("#settings").empty();_.each(e,function(e){$("#settings").append('<tr s_id="'+e.Id+'"><td>'+e.Name+"</td><td>"+e.CreateAt+'</td><td><button type="button" class="btn btn-primary btn-sm import_s_item">瀵煎叆</button>  <button type="button" class="btn btn-default btn-sm delete_setting">鍒犻櫎</button></td></tr>')})},error:function(){}})},delete_search:function(e){var t=$(e.currentTarget).parents("tr");var a=t.attr("s_id");$.ajax({url:"/usersetting/deletesetting",data:{id:a},dataType:"JSON",type:"POST",success:function(e){t.remove()}})},import_s_item:function(e){var t=$(e.currentTarget).parents("tr:eq(0)").attr("s_id");var a=this;$.ajax({url:"/usersetting/loadsetting",data:{id:t},dataType:"JSON",type:"get",success:function(e){var t=JSON.parse(e.Value);for(var r=0;r<t.rows.length;r++){a.rows.add(t.rows[r])}for(var i=0;i<t.cols.length;i++){a.cols.add(t.cols[i])}$("#import_modal").modal("hide");$("#search").click()},error:function(e){}})}});
var ComputerView=Backbone.View.extend(
{
	el:$("#content"),
	events:{'click #new_rounds input[type="checkbox"]':"checkRounds","click #computer":"computer","click #select_jiqi":"select_jiqi","click #save":"save_jiqi","click #default":"defaultJiqi","click #round_nav a":"navRounds"},
	initialize:function(){this.loadRounds();var e=this.loadRounds;$("#modal_loading").on("hidden.bs.modal",function(){e()})},
	loadRounds:function(){
		$.ajax({
			url:"/computer/availablerounds",
			type:"get",
			cache:false,
			data:{dateType:$("#date_type").val()},
			dataType:"json",
			success:function(e){
				$("#new_rounds").empty();
				var t=_.template('<tr><td><input type="checkbox" checked="checked" id="<%=Value%>" value="<%=Key%>"/></td><td><label for="<%=Value%>"><%=Value%></label></td></tr>');
				_.each(e,function(e){
				$("#new_rounds").append(t(e))})
			},
			error:function(){}
		})
	},
	checkRounds:function(e){var t=$('#new_rounds input[type="checkbox"]').index($(e.currentTarget));
	if($(e.currentTarget).prop("checked")){$('#new_rounds input[type="checkbox"]:gt('+t+")").prop("checked","checked")}
	else{$('#new_rounds input[type="checkbox"]:lt('+t+")").prop("checked",false)}},
	computer:function(e){var t=$("#date_type").val();var a=$("#jiqiround").attr("round");var r=$("#new_rounds :checked");var i=function(e){if(e>=0){var s={datetype:t,jiqiround:a,round:$(r[e]).val()};$.ajax({dataType:"json",url:"/computer/docomputer",data:s,type:"post",success:function(t){if(t.success){$('#do_rounds p[rd="'+s.round+'"] span').removeClass("glyphicon-time").addClass("glyphicon-ok");e--;i(e)}else{var a=t.info||"璁＄畻澶辫触";$("#do_result").text("璁＄畻澶辫触锛�"+a);$("#modal_loading .modal-footer button").show()}},error:function(){$("#do_result").text("璁＄畻澶辫触");$("#modal_loading .modal-footer button").show()}})}else{$("#do_result").text("璁＄畻瀹屾垚");$("#modal_loading .modal-footer button").show()}};if(r.length>0){$("#do_rounds,#do_result").empty();r.each(function(e,t){$("#do_rounds").prepend('<p rd="'+$(t).val()+'">'+$(t).attr("id")+'&nbsp;&nbsp;&nbsp;<span class="glyphicon glyphicon-time"></span></p>')});$("#modal_loading .modal-footer button").hide();$("#modal_loading").modal({backdrop:"static",show:true});setTimeout(function(){i(r.length-1)},400)}},
	select_jiqi:function(e){
		$("#modal").modal("show");
		
		},
		get_rounds:function(){$.ajax({url:"/indexround/items",
		data:{datetype:$("#datetype").val(),postcode:$("#postcode").val(),page:page},
		type:"get",
		cache:false,
		success:function(e){if(e&&e.length>0){
			$("#modal #round_list").empty();_.each(e,function(e){$("#modal #round_list").append('<li><input type="checkbox" value="" id="round_'+e.Id+'" round="'+e.RoundDate+'"/>&nbsp;&nbsp;<label for="round_'+e.Id+'">'+e.IndexDate+"</label><li>")});$("#round_nav").attr("page",page)}}})},save_jiqi:function(){var e=$("#round_list :checked");if(e.length==0){alert("璇烽€夋嫨鍩烘湡")}else if(e.length>1){alert("鍙兘閫夋嫨涓€涓湡娆★紒")}else{var t=e.attr("round");$("#jiqiround").text("锛�"+e.next().text()+"锛�").attr("round",t);$("#modal").modal("hide")}},defaultJiqi:function(){$("#jiqiround").text("锛堥粯璁わ級").removeAttr("round");$("#modal").modal("hide")},navRounds:function(e){var t=e.currentTarget.innerHTML;var a=parseInt($("#round_nav").attr("page"));if(t=="涓婁竴椤�"){a=a-1;if(a==0){return}}else{a=a+1}get_rounds(a)}});var TempComputerView=Backbone.View.extend({el:$("#content"),events:{"click #temp_computer_nav a":"nav","click .show-modal":"showModal","click #select_cats :checkbox":"check_cats","click #price_import_new":"price_import_new","click #price_import_range":"price_import_range","click #price_search_ronnds":"price_search_ronnds","click .price_round_import":"price_round_import","change #excel_file":"price_excel_sub","click #excle_import_price":"excle_import_price","click #fetch_price":"fetch_price","click .price_edit":"price_edit","blur #price_list :text":"price_sub","click #dingji_default":"dingji_default","click #huanbi_default":"huanbi_default","click #tongbi_default":"tongbi_default","click #do_computer":"do_computer","click #fetch_index":"fetch_index","click .trend_compare":"trend_compare"},initialize:function(){this.pageTemp=_.template($("#tempPage").html());this.postcode=$("#postcode").val()},nav:function(e){e.preventDefault();var t=$(e.currentTarget);if($(e.currentTarget).text()=="娓呯┖鏁版嵁"){if(confirm("鏄惁纭娓呯┖涓存椂璁＄畻鐨勬暟鎹�")){$.ajax({type:"POST",dataType:"json",url:"/tempcomputer/empty",success:function(e){if(e.success){t.text("娓呯┖鎴愬姛!");setTimeout(function(){t.text("娓呯┖鏁版嵁")},1e3);$("#price_list,#price_info,#index_list,#index_info").empty()}else{alert("娓呯┖澶辫触锛岃閲嶈瘯")}},error:function(){alert("绯荤粺鎴栫綉缁滈敊璇�")}})}}else{t.parent().hasClass("active")||$("#temp_computer_nav .active").removeClass("active")&&t.parent().addClass("active")&&$("div.show").removeClass("show").addClass("hide")&&$(t.attr("href")).removeClass("hide").addClass("show")}},showModal:function(e){e.preventDefault();$("#modal .modal-content").html($($(e.currentTarget).attr("href")).html());this.importType=$(e.currentTarget).attr("imp")||null;$("#modal").modal("show");$("#modal .dp").datepicker()},check_cats:function(e){var t=$(e.currentTarget);if(t.val()=="-1"){if(t.prop("checked")){$("#select_cats :checkbox").prop("checked",true)}else{$("#select_cats :checkbox").prop("checked",false)}}else if(t.val()=="0"){if(!t.prop("checked")){$("#select_cats :checkbox:eq(0)").prop("checked",false)}}else{var a=t.parent().next().find(":checkbox");if(t.prop("checked")){a.prop("checked",true)}else{a.prop("checked",false);$("#select_cats :checkbox:eq(0)").prop("checked",false)}}},price_search_ronnds:function(e){this.price_round_type=$("#price_round_datetype").val();$("#modal_contains").empty();$.getJSON("/indexround/Items",{datetype:this.price_round_type,postcode:this.postcode},function(e){_.each(e,function(e){$('<li class="list-group-item"><span>'+e.IndexDate+'</span><button class="btn btn-default btn-sm pull-right price_round_import" data-loading-text="瀵煎叆涓�..." rid="'+e.Id+'">閫夋嫨</button></li>').appendTo("#modal_contains")});$("#modal_contains").append($("#tempRoundPage").html())})},price_round_import:function(e){var t=$(e.currentTarget).attr("rid");var a=$(e.currentTarget).prev("span").text();if(this.importType=="price"){var r={round:t};this.price_import(e,r)}else{$("#"+this.importType+"_base").val(t);$("#"+this.importType+"_show").text(a)}},price_import:function(e,t,a){a=a?a:"瀵煎叆鎴愬姛!";var r=this;var i=$(e.currentTarget);i.button("loading");$.post("/tempcomputer/price",t,function(e){if(e.success){$("#info").html('<div class="alert alert-success alert-dismissable"><button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button><strong>'+a+"</strong></div>");$("#fetch_price").click()}else{alert(e.info)}i.button("reset")},"json")},price_import_new:function(e){this.price_import(e,{})},price_import_range:function(e){if(!$("#price_start").val()||!$("#price_end").val()){alert("璇疯緭鍏ユ棩鏈�");return}var t={start:$("#price_start").val(),end:$("#price_end").val()};this.price_import(e,t)},price_excel_sub:function(e){var t=$("#excle_import_price");t.button("loading");$("#excel_form").ajaxSubmit({success:function(e){t.button("reset");if(e.success){alert("瀵煎叆鎴愬姛")}else{alert("瀵煎叆澶辫触锛�"+e.info)}},error:function(e){t.button("reset")},dataType:"json",data:{}})},excle_import_price:function(e){$("#excel_file").click()},fetch_price:function(e){var t=$(e.currentTarget);t.button("loading");var a=this;$("#price_info,#price_list").empty();$.ajax({type:"GET",url:"/tempcomputer/getprice",data:{},dataType:"json",cache:false,success:function(e){t.button("reset");if(e){var a=_.template($("#temp_price").html());$("#price_list").append(a({cats:e.data}));$("#price_info").text(e.info)}},error:function(){t.button("reset")}})},price_edit:function(e){var t=$(e.currentTarget);t.find(":text").removeClass("hide").addClass("show").focus();t.find("span").removeClass("show").addClass("hide")},price_sub:function(e){var t=$(e.currentTarget);if(!parseFloat(t.val())||isNaN(parseFloat(t.val()))){return}else{var a={id:t.parent().attr("p_id"),price:parseFloat(t.val()).toFixed(2)};$.ajax({url:"/tempcomputer/oneprice",type:"POST",dataType:"json",data:a,success:function(){t.removeClass("show").addClass("hide").val(a.price).prev().removeClass("hide").addClass("show").text(a.price)}})}},get_date_name:function(e){return e=="day"?"鏃�":e=="week"?"鍛�":e=="month"?"鏈�":e=="season"?"瀛�":"year"},dingji_default:function(e){var t=$("#dingji_default_type").val();$("#dingji_base").val(t);$("#dingji_show").text("涓婃湡"+this.get_date_name(t)+"鎸囨暟")},huanbi_default:function(e){var t=$("#huanbi_default_type").val();$("#huanbi_base").val(t);$("#huanbi_show").text("涓婃湡"+this.get_date_name(t)+"浠锋牸")},tongbi_default:function(e){var t=$("#tongbi_default_type").val();$("#tongbi_base").val(t);$("#tongbi_show").text("鍘诲勾鍚屾湡"+this.get_date_name(t)+"浠锋牸")},do_computer:function(e){var t=$(e.currentTarget);t.button("loading");var a={dingji:$("#dingji_base").val()||"day",huanbi:$("#huanbi_base").val()||"day",tongbi:$("#tongbi_base").val()||"month"};$.ajax({url:"/tempcomputer/docomputer",type:"POST",dataTyoe:"json",data:a,success:function(e){t.button("reset");if(e.success){$("#fetch_index").click()}else{alert("璁＄畻澶辫触"+e.info)}},error:function(e){t.button("reset")}})},fetch_index:function(e){var t=$(e.currentTarget);t.button("loading");var a=this;$("#index_info,#index_list").empty();$.ajax({type:"GET",url:"/tempcomputer/getindex",data:{},dataType:"json",cache:false,success:function(e){t.button("reset");if(e){var a=_.template($("#temp_index2").html());$("#index_list").append(a({cats:e.data}));$("#index_info").text(e.info)}},error:function(){t.button("reset")}})},trend_compare:function(e){var t=[];$("#trend_types :checked").each(function(e,a){t.push(a.value)});if(t.length<=0){alert("璇烽€夋嫨瑕佸睍绀虹殑鏁版嵁鏃堕棿绫诲瀷");return}$.ajax({url:"/tempcomputer/trendindex",traditional:true,dataType:"json",type:"get",data:{datetypes:t,category:"0"},success:function(e){$("#modal .modal-content").initChart(e.series,{title:e.name,width:850});$("#modal").modal("show")},error:function(e,t){}})}});var PriceBaseView=Backbone.View.extend({el:$("#content"),events:{"click .edit":"show_edit","click #save_edit":"save_edit"},initialize:function(){this.template=_.template($("#edit_price_temp").html())},show_edit:function(e){var t=$(e.currentTarget);var a=t.parent().prev().text();var r=t.parent().prev().prev().text();this.category=t.data("code");$("#modal .modal-content").html(this.template({price:a,name:r}));$("#modal").modal("show")},save_edit:function(e){var t=parseFloat($("#price").val());if(isNaN(t)){$("#info_price").html('<div class="alert alert-danger alert-dismissable"><button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button><strong>璇疯緭鍏ユ纭殑浠锋牸</strong></div>');return}var a=$(e.currentTarget).button("loading");var r=this.category;$.ajax({type:"post",url:"/pricebase/item",data:{category:this.category,postcode:$("#base_price_postcode").val(),datetype:$("#base_price_datetype").val(),price:$("#price").val()},dataType:"json",success:function(t){$(e.currentTarget).button("reset");if(t.success){console.log($(".price_"+r));$(".price_"+r).text(t.price);$("#info_price").html('<div class="alert alert-success alert-dismissable"><button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button><strong>淇濆瓨鎴愬姛!</strong></div>')}else{$("#info_price").html('<div class="alert alert-danger alert-dismissable"><button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button><strong>鍑洪敊浜�!</strong>'+t.info+"</div>")}},error:function(){$("#info_price").html('<div class="alert alert-danger alert-dismissable"><button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button><strong>缃戠粶鎴栫郴缁熼敊璇�!</strong></div>');$(e.currentTarget).button("reset")}})}});